SELECT id_almacen, fk_materia_prima,
	   CASE WHEN cantidad_total IS NULL THEN cantidad ELSE cantidad_total END AS cantidad_usable
FROM (
	SELECT a.id_almacen, a.fk_materia_prima, a.cantidad, (a.cantidad - SUM(das.cantidad)) AS cantidad_total, a.caducidad
	FROM almacen a
	LEFT JOIN detalle_almacen_stock das
	ON id_almacen = fk_almacen
	WHERE estatus = TRUE
	AND DATE(caducidad) > DATE(NOW())
	GROUP BY a.id_almacen, a.caducidad, a.estatus, a.fk_materia_prima
	HAVING cantidad_total IS NULL OR cantidad_total > 0
	ORDER BY a.caducidad DESC
) AS t;

SELECT a.id_almacen, a.fk_materia_prima, a.cantidad, (a.cantidad - SUM(das.cantidad)) AS cantidad_total, a.caducidad
FROM almacen a
LEFT JOIN detalle_almacen_stock das
ON id_almacen = fk_almacen
WHERE estatus = TRUE
AND DATE(caducidad) > DATE(NOW())
GROUP BY a.id_almacen, a.caducidad, a.estatus, a.fk_materia_prima
HAVING cantidad_total IS NULL OR cantidad_total > 0
ORDER BY a.caducidad DESC;

SELECT id_stock, caducidad, cantidad, precio, estatus FROM stock;
SELECT * FROM stock;
SELECT id_detalle_venta, cantidad, precio, fk_stock, fk_venta FROM detalle_venta;




